/*
* For the moment, running gradle modAPK followed by gradle APK should yield a modded APK that can be signed then installed.
* There is no automatic signing yet, I sign the APK with my own keystore. Some emulators can run unsigned APKs,
* so if you're running the APK on an emulator (as you should) you can forego the signing for the moment.
* Not a top priority until alpha release maybe?
*
*
* modAPK compiles both chimera and mod java files, decompiles the apk inside saterskog/cell.apk, patches it using patcher.jar in /tools/patcher.jar
* and the patch file in saterskog/patch.chimera, then it uses d8 to convert .class mod and chimera files to classes.dex and finally baksmali to
* obtain smali files which it then inserts into the APK at the correct locations. Not to mention the mods.txt manifest inside the /assets/ folder of the APK.
* There certainly is a more straightfoward way to convert java to smali and I will switch to that later on, but for testing purposes baksmali works well.
*/

repositories {
    google()
    mavenCentral()
    maven {
        url 'https://storage.googleapis.com/r8-releases/raw'
    }
}

dependencies {
    configurations.maybeCreate("r8")
    r8 "com.android.tools:r8:8.2.55"
}

// Task to compile Chimera-specific Java files
task buildChimera(type: Exec) {
    description 'Compiles Chimera Java files into build/chimera directory'

    def javaFiles = fileTree('src/com/saterskog/cell_lab')
            .include('**/*.java')
            .collect { it.absolutePath }

    file('build/chimera').mkdirs()
    // Using --release since android tends to lag behind newer jdks and using jdk 21 makes d8 throw an error due to it being too new.
    commandLine 'javac','--release','17','-d', 'build/chimera', *javaFiles
}

task buildAll(type: Exec) {
    description 'Compiles all Java files into build/chimera directory'

    def javaFiles = fileTree('src/com/saterskog')
            .include('**/*.java')
            .collect { it.absolutePath }

    file('build/chimera').mkdirs()
    // Using --release since android tends to lag behind newer jdks and using jdk 21 makes d8 throw an error due to it being too new.
    commandLine 'javac', '--release', '17','-d', 'build/chimera', *javaFiles
}

// Temporary!
//TODO: CHANGE THIS!
task buildMod {
    description 'Builds the mod by depending on buildAll'
    dependsOn buildAll
}

// Task to generate DEX file for mod classes Dont mind the debugging.
tasks.register('getDex', Exec) {
    description 'Converts mod class files to DEX format using AGP D8'
    dependsOn buildMod

    def classDir = file('build/chimera/com/saterskog')
    def outputDir = file('build/dex_output')

    inputs.dir(classDir)
    outputs.dir(outputDir)

    doFirst {
        def d8Jar = configurations.r8.files.find { it.name.contains("r8") }
        if (d8Jar == null) {
            throw new GradleException("D8 JAR not found in dependencies. Make sure R8 is included!")
        }

        def classes = fileTree(classDir).include('**/*.class').collect { it.absolutePath }
        println "Found class files: ${classes ?: 'None'}"

        outputDir.mkdirs()
        fileTree(outputDir).each { it.delete() }

        if (!classes) {
            throw new GradleException("No class files found in ${classDir.absolutePath}")
        }

        commandLine 'java', '-cp', d8Jar, 'com.android.tools.r8.D8', '--output', outputDir, *classes
    }
}

// Task to disassemble DEX into Smali
task getSmali(type: Exec) {
    description 'Disassembles DEX file into Smali code'
    dependsOn getDex

    workingDir file('tools')

    commandLine 'java', '-jar', 'baksmali-2.5.2.jar', 'd',
            '../build/dex_output/classes.dex', '-o', '../build/smali'
}

//TODO: Work with locally installed APK-tool, don't just assume it's globally installed.
//TODO: also, add compatibility for other cell lab APKs.
//This is really hard-codey, I just want to go to sleep rn, i'll fix it later.
task deAPK(type: Exec){
    workingDir file('saterskog')
    mkdir("saterskog/apk")
    commandLine 'apktool','d','cell.apk','-o','./apk','-f'
}

//This should never be called alone, APK will have runtime errors if ChimeraHooks.smali isn't included inside
//This must run sequentially since patches are supposed to build ontop of the previos file's worth.
task patchAPK {
    doFirst {
        def directory = file('saterskog')
        def chimeraFiles = directory.listFiles({ file -> file.name.endsWith('.chimera') } as FileFilter)

        if (!chimeraFiles) {
            throw new GradleException("No .chimera files found in ${directory.absolutePath}")
        }

        chimeraFiles.each { chimeraFile ->
            println "Patching: ${chimeraFile.absolutePath}"
            exec {
                workingDir projectDir
                commandLine 'java', '-jar', './tools/patcher.jar', 'saterskog/apk/smali', chimeraFile.absolutePath
            }
        }
    }

    doLast {
        println "All patches applied."
    }
}

task APK(type: Exec){
    commandLine 'apktool','b','saterskog/apk','-o','build/apk/mod.apk'
}

// This will find source files (.java) for mods in com/saterskog/mods and add them to mods.txt
// Do note that only classes annotated @ChimeraMod will be loaded as mods.
// There is a hacky workaround maybe using static blocks but that's some nerd shit
//TODO: make a task that can find mod binaries (.jar?), convert to smali and also add them.
//TODO: maybe have gradle inspect jar, retrieve classes, update mods.txt THEN convert to smali and bundle inside APK.
//TODO: that should greatly simplify multi-mod bundling, skipping the compilation entirely for pre-compiled mods.
task findModSources {
    def directory = file('src/com/saterskog/mods')
    def outputFile = file('saterskog/mods.txt')

    doLast {
        outputFile.parentFile.mkdirs()
        outputFile.createNewFile()

        outputFile.text = ""

        directory.eachFileRecurse { file ->
            if (file.name.endsWith('.java')) {
                String fullyQualifiedName = file.path.replace(directory.path + File.separator, '')
                        .replace(File.separator, '.').replace('.java', '')

                outputFile.append('com.saterskog.mods.'+fullyQualifiedName + '\n')
            }
        }
    }
}

//This task should insert the mods.txt file inside apk/assets/ where it is expected to be.
task insertModManifest(type: Copy) {
    from 'saterskog/mods.txt'
    into 'saterskog/apk/assets'
    doLast {
        if (!file('saterskog/mods.txt').exists()) {
            throw new GradleException("Could not fetch mod manifest file!")
        }
        if (!file('saterskog/apk/assets').exists()) {
            throw new GradleException("Assets folder does not exist. Make sure to decompile the apk correctly!")
        }
        println "Mod manifest successfully copied into assets folder"
    }
}

task insertModFiles(type: Copy) {
    from 'build/smali/com/saterskog/mods'
    into 'saterskog/apk/smali/com/saterskog/mods'

    doFirst {
        def sourceDir = file('build/smali/com/saterskog/mods')
        if (!sourceDir.exists()) {
            throw new GradleException("Could not fetch mod smali files!")
        }
    }

    doLast {
        def destinationDir = file('saterskog/apk/smali/com/saterskog/mods')
        if (!destinationDir.exists()) {
            destinationDir.mkdirs()
            println "Created mods directory"
        }
        println "Mod files successfully bundled in APK"
    }
}

task insertChimeraHooks(type: Copy) {
    from 'build/smali/com/saterskog/cell_lab'
    into 'saterskog/apk/smali/com/saterskog/cell_lab'

    doFirst {
        def sourceDir = file('build/smali/com/saterskog/cell_lab')
        if (!sourceDir.exists()) {
            throw new GradleException("Could not fetch Chimera smali files!")
        }
    }

    doLast {
        def destinationDir = file('saterskog/apk/smali/com/saterskog/cell_lab')
        if (!destinationDir.exists()) {
            destinationDir.mkdirs()
            println "Inserted Chimera core files"
        }
        println "Chimera core files successfully bundled in APK"
    }
}

task modAPK{
    dependsOn deAPK,patchAPK,getSmali,findModSources,insertModManifest,insertChimeraHooks,insertModFiles
}

// Task to clean the build directory
task cleanBuild(type: Delete) {
    description 'Deletes the build directory'
    delete 'build'
}

task cleanAPK(type: Delete) {
    description 'Deletes the apk decompilation directories'
    delete 'saterskog/apk'
}

task debugJavac(type: Exec) {
    commandLine 'javac', '-version'
}
